{% extends 'base.html' %}
{% block title %}Dashboard - FinSight AI{% endblock %}
{% block content %}

<div class="container my-5 text-white">
  <h1 class="mb-4 text-center text-indigo-400 font-bold text-3xl">
    Financial Dashboard for {{ username|default:'Guest' }}
  </h1>

  <!-- Latest Analysis -->
  <div class="card p-4 mb-4 shadow-lg bg-white/10 backdrop-blur-md border border-white/20 rounded-lg">
    <h4 class="mb-3 text-indigo-300 font-semibold">Latest Analysis</h4>
    <div class="p-3 bg-slate-800/50 rounded-lg">
      {% if latest_summary %}
        {{ latest_summary|linebreaks }}
      {% else %}
        <p class="text-gray-400 italic">No analysis available yet. Please upload a financial file to get started!</p>
      {% endif %}
    </div>
  </div>

  <!-- Goal Progress -->
 <div class="card p-4 mb-4 shadow-lg bg-white/10 backdrop-blur-md border border-white/20 rounded-lg">
  <h4 class="mb-3 text-indigo-300 font-semibold">Your Financial Goal</h4>
  
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div class="text-center p-3 bg-slate-800/50 rounded-lg">
      <div class="text-3xl font-bold text-green-400">${{ current_amount|default:0 }}</div>
      <div class="text-sm text-gray-400 mt-1">Current</div>
    </div>
    <div class="text-center p-3 bg-slate-800/50 rounded-lg">
      <div class="text-3xl font-bold text-indigo-400">{{ goal_progress|default:0 }}%</div>
      <div class="text-sm text-gray-400 mt-1">Progress</div>
    </div>
    <div class="text-center p-3 bg-slate-800/50 rounded-lg">
      <div class="text-3xl font-bold text-purple-400">${{ goal_amount|default:0 }}</div>
      <div class="text-sm text-gray-400 mt-1">Target</div>
    </div>
  </div>
  
  <p class="text-gray-300 text-center">{{ ai_message|default:'Set a goal to receive personalized encouragement!' }}</p>
</div>

  <!-- Spending Breakdown -->
  <div class="card p-4 mb-4 shadow-lg bg-white/10 backdrop-blur-md border border-white/20 rounded-lg">
    <h4 class="mb-3 text-indigo-300 font-semibold">Spending Breakdown</h4>
    <div class="chart-container" style="position: relative; min-height: 300px;">
      <canvas id="spendingChart"></canvas>
    </div>
    {% if chart %}
      <div class="mt-3">
        <img src="data:image/png;base64,{{ chart }}" class="img-fluid rounded-lg" alt="Spending Pie Chart">
      </div>
    {% else %}
      <div class="alert alert-warning mt-3 rounded-lg">No chart available. Upload a CSV with Category and Amount columns.</div>
    {% endif %}
  </div>

  <div class="text-center mt-4">
    <a href="{% url 'set_goal' %}" class="btn btn-success px-4 py-2 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
      Set a New Goal
    </a>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('spendingChart');
    if (!ctx) return;

    // Parse data safely
    const pieData = {
      labels: JSON.parse('{{ pie_data.labels|default:"[]"|escapejs }}'),
      datasets: [{
        data: JSON.parse('{{ pie_data.data|default:"[]"|escapejs }}'),
        backgroundColor: [
          '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'
        ]
      }]
    };

    // Render chart only if there's valid data
    if (pieData.datasets[0].data.length > 0 && pieData.datasets[0].data.some(v => v > 0)) {
      new Chart(ctx, {
        type: 'pie',
        data: pieData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'top', 
              labels: { color: '#e5e7eb' } 
            },
            title: { 
              display: true, 
              text: 'Spending by Category', 
              color: '#e5e7eb',
              font: { size: 16 }
            }
          }
        }
      });
    } else {
      // Hide canvas & show warning if no valid data
      ctx.style.display = 'none';
      const noDataDiv = document.createElement('div');
      noDataDiv.className = 'alert alert-warning mt-3 rounded-lg';
      noDataDiv.textContent = 'No valid spending data to chart.';
      document.querySelector('.chart-container').appendChild(noDataDiv);
    }
  });
</script>

{% endblock %}